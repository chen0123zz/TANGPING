<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èººå¹³é‹å‹•æŒ‰æ‘© TANG PING - é ç´„å®˜ç¶²</title>
    <link rel="icon" href="images/LOGO2.png" type="image/png">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ğŸ¨ å…¨åŸŸè¨­å®š */
        :root { --brand-color: #efb748; --bg-beige: #f9f5f0; --text-dark: #333333; --admin-bg: #f0f2f5; --admin-card: #ffffff; --admin-text: #333333; }
        html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
        body { font-family: 'Noto Sans TC', sans-serif; margin: 0; padding: 0; background-color: var(--bg-beige); color: var(--text-dark); }
        
        /* ğŸ  å‰å°æ¨£å¼ (V40ç‰ˆ) */
        header { background-color: #fff; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1000px; margin: 0 auto; }
        .logo-img { height: 50px; }
        .nav-menu a { text-decoration: none; color: #333; margin-left: 20px; font-weight: bold; }
        .content-section { padding: 40px 20px; max-width: 800px; margin: 0 auto; text-align: center; }
        .section-title { color: var(--brand-color); font-size: 2rem; margin-bottom: 10px; }
        .btn-main { display: inline-block; background-color: #fff; color: var(--brand-color); padding: 12px 30px; border-radius: 30px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Swiper */
        .offerSwiper { width: 100%; padding: 20px 0 50px 0; }
        .offer-card-layout { background: #fff; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; max-width: 900px; margin: 0 auto; }
        .offer-img-box { flex: 1; min-height: 300px; display: flex; align-items: center; justify-content: center; background-color: #fff; padding: 30px; }
        .offer-img-box img { width: 100%; height: 100%; object-fit: contain; }
        .offer-text-box { flex: 1; padding: 40px; text-align: left; display: flex; flex-direction: column; justify-content: center; }
        .tag-pill { display: inline-block; background-color: #ff4757; color: #fff; padding: 5px 15px; border-radius: 50px; font-size: 0.9rem; font-weight: bold; margin-bottom: 10px; }
        .price-highlight { display: flex; gap: 15px; background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px; color: var(--brand-color); }
        
        /* Calendar UI */
        .booking-container { background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); max-width: 700px; margin: 0 auto; text-align: left; }
        .month-selector { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .month-btn { background: none; border: 1px solid #ddd; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .month-title-group { display: flex; flex-direction: column; align-items: center; }
        .today-btn { font-size: 0.75rem; padding: 2px 10px; margin-top: 5px; background: #eee; color: #666; border: none; border-radius: 15px; cursor: pointer; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-bottom: 30px; }
        .cal-header { font-size: 0.8rem; font-weight: bold; color: #888; padding-bottom: 5px; text-align: center; }
        .calendar-day { border: 1px solid #ddd; border-radius: 12px; height: 75px; text-align: center; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .calendar-day.active { background-color: var(--brand-color); color: #fff; border-color: var(--brand-color); }
        .calendar-day.disabled { background-color: #f9f9f9; color: #ccc; cursor: not-allowed; pointer-events: none; }
        .calendar-day.today { border: 2px solid var(--brand-color); color: var(--brand-color); font-weight: bold; }
        /* ğŸ”¥ å‰å°åº—ä¼‘æ¨£å¼ */
        .calendar-day.holiday { background-color: #fff0f0 !important; border-color: #ffcccc !important; color: #d63031 !important; pointer-events: none; }
        
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .time-btn { padding: 10px; background: #fff; border: 1px solid var(--brand-color); border-radius: 5px; color: var(--brand-color); cursor: pointer; }
        .time-btn.selected { background-color: var(--brand-color); color: #fff; }
        .time-btn.disabled { background-color: #f0f0f0; color: #ccc; cursor: not-allowed; pointer-events: none; }

        /* Contact */
        .contact-container { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .map-box { height: 300px; border-radius: 15px; overflow: hidden; }
        .time-list-desktop { white-space: nowrap !important; display: block !important; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .contact-info .btn-main { width: auto; }

        /* ğŸ” Admin Styles */
        #admin-panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--admin-bg); z-index: 10000; overflow-y: auto; color: var(--admin-text); }
        .admin-header { background-color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .admin-container { max-width: 600px; margin: 20px auto; padding: 0 15px; padding-bottom: 60px; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .dash-card { background: #fff; padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid var(--brand-color); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .dash-num { font-size: 1.8rem; font-weight: bold; color: #333; margin: 5px 0; }
        .dash-label { font-size: 0.8rem; color: #888; }

        .admin-card { background: #fff; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .admin-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .admin-cal-cell { aspect-ratio: 1/1; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 8px; border: 1px solid #eee; font-size: 0.9rem; cursor: pointer; position: relative; background: #fff; transition: all 0.2s; color: #333; }
        .admin-cal-cell.today { border: 2px solid var(--brand-color); font-weight: bold; }
        .admin-cal-cell.selected { background-color: var(--brand-color); color: #fff; border-color: var(--brand-color); }
        .admin-cal-cell.holiday { background-color: #fff0f0; color: #d63031; }
        .dot { width: 6px; height: 6px; border-radius: 50%; margin-top: 2px; background-color: #2ecc71; display: none; }
        .dot.active { display: block; }
        .event-text { display: none; }

        .admin-cal-grid.detail-mode .admin-cal-cell { aspect-ratio: auto; min-height: 80px; justify-content: flex-start; padding-top: 5px; align-items: stretch; }
        .admin-cal-grid.detail-mode .dot { display: none; } 
        .admin-cal-grid.detail-mode .event-text { display: block; font-size: 0.65rem; color: #fff; background-color: #2ecc71; margin: 2px 0; padding: 2px 4px; border-radius: 3px; text-align: left; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        
        .order-item { background: #f9f9f9; border-left: 4px solid var(--brand-color); padding: 10px 15px; margin-bottom: 10px; border-radius: 5px; }
        .order-time { font-weight: bold; color: #333; font-size: 1rem; }
        .order-info { color: #666; font-size: 0.95rem; margin-top: 5px; line-height: 1.5; }
        .order-price { font-weight: bold; color: #e67e22; }
        
        .admin-big-btn-group { display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        .admin-big-btn { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; color: #fff; display: flex; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-holiday-big { background-color: #e74c3c; }
        .btn-open-big { background-color: #2ecc71; display: none; /* é è¨­éš±è—ï¼Œæœ‰ä¼‘å‡æ‰é¡¯ç¤º */ }

        #booking-modal-overlay, #admin-login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 10002; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .booking-modal, .admin-login-box { background: #fff; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; }
        .form-input, .form-select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; margin-bottom: 10px; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        #toast-msg { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; z-index: 20000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        
        .admin-toolbar { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .admin-tool-btn { background-color: #fff; border: 1px solid #ddd; color: #666; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        @media (max-width: 768px) {
            .offer-card-layout { flex-direction: column; }
            .contact-container { display: flex; flex-direction: column; gap: 30px; }
            .btn-group { flex-direction: column; }
            .contact-info .btn-main { width: 100%; margin: 0; }
            .calendar-day { width: 100%; height: auto; aspect-ratio: 1/1; font-size: 0.75rem; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <img src="images/logo.png" alt="èººå¹³é‹å‹•æŒ‰æ‘© LOGO" class="logo-img">
            <nav class="nav-menu">
                <a href="#news">æœ€æ–°å„ªæƒ </a>
                <a href="#services">åƒ¹ç›®è¡¨</a>
                <a href="#booking">é ç´„</a>
                <a href="#contact">è¯çµ¡</a>
            </nav>
        </div>
    </header>

    <section class="content-section" id="booking">
        <h2 class="section-title">ç·šä¸Šé ç´„</h2>
        <div class="booking-container">
            <div class="date-selector">
                <div class="month-selector">
                    <button class="month-btn" onclick="prevMonth()">â®</button>
                    <div class="month-title-group">
                        <h3 id="currentMonthYear" style="margin-bottom:0;">12æœˆ (2025)</h3>
                        <button class="today-btn" onclick="resetToToday()">å›åˆ°ä»Šå¤©</button>
                    </div>
                    <button class="month-btn" onclick="nextMonth()">â¯</button>
                </div>
                <div class="calendar-grid" id="calendar-grid-front"></div>
            </div>
            <div class="time-selector">
                <h3>2. é¸æ“‡æ™‚æ®µ</h3>
                <div class="time-grid">
                    <button class="time-btn" onclick="openBookingForm('10:00')">10:00</button>
                    <button class="time-btn" onclick="openBookingForm('12:00')">12:00</button>
                    <button class="time-btn" onclick="openBookingForm('14:00')">14:00</button>
                    <button class="time-btn" onclick="openBookingForm('15:40')">15:40</button>
                    <button class="time-btn" onclick="openBookingForm('17:10')">17:10</button>
                    <button class="time-btn" onclick="openBookingForm('19:30')">19:30</button>
                    <button class="time-btn" onclick="openBookingForm('21:10')">21:10</button>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <p>Â© 2025 TANG PING Sport Massage.</p>
        <p style="margin-top:10px;"><span onclick="openAdmin()" style="opacity:0.2; cursor:pointer; font-size:1.2rem;">ğŸ”’</span></p>
    </footer>

    <div id="booking-modal-overlay">
        <div class="booking-modal">
            <button class="modal-close" onclick="closeBookingForm()">Ã—</button>
            <h3>é ç´„ç¢ºèª</h3>
            <p id="booking-info-text" style="color:#666; font-size:0.9rem; margin-bottom:15px; text-align:center;"></p>
            <div class="form-group"><label>å§“å</label><input type="text" id="booking-name" class="form-input" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å"></div>
            <div class="form-group"><label>è¯çµ¡é›»è©±</label><input type="tel" id="booking-phone" class="form-input" placeholder="09xx-xxx-xxx"></div>
            <div class="form-group"><label>LINE ID (é¸å¡«)</label><input type="text" id="booking-line" class="form-input" placeholder="æ–¹ä¾¿æˆ‘å€‘è¯ç¹«æ‚¨"></div>
            <div class="form-group">
                <label>æœå‹™é …ç›®</label>
                <select id="booking-service" class="form-select">
                    <option value="å°ˆæ¥­é‹å‹•æŒ‰æ‘© 60min ($1,200)">å°ˆæ¥­é‹å‹•æŒ‰æ‘© 60min ($1,200)</option>
                    <option value="å°ˆæ¥­é‹å‹•æŒ‰æ‘© 90min ($1,800)">å°ˆæ¥­é‹å‹•æŒ‰æ‘© 90min ($1,800)</option>
                    <option value="å¼µåŠ›èª¿æ•´ 60min ($1,400)">å¼µåŠ›èª¿æ•´ 60min ($1,400)</option>
                    <option value="å¼µåŠ›èª¿æ•´ 90min ($2,000)">å¼µåŠ›èª¿æ•´ 90min ($2,000)</option>
                    <option value="ä½¿ç”¨åŒ…å ‚æ–¹æ¡ˆ (æ‰£1å ‚)">ä½¿ç”¨åŒ…å ‚æ–¹æ¡ˆ (æ‰£1å ‚)</option>
                </select>
            </div>
            <button id="confirm-btn" class="btn-main" style="width:100%; border:none; margin-top:10px;" onclick="confirmBooking()">ç¢ºèªé€å‡º</button>
        </div>
    </div>

    <div id="admin-login-overlay">
        <div class="admin-login-box">
            <h2 style="color:var(--brand-color);">å¾Œå°ç®¡ç†ç³»çµ±</h2>
            <input type="password" id="admin-password" class="login-input" placeholder="å¯†ç¢¼">
            <button class="login-btn" onclick="checkAdminLogin()">ç™»å…¥</button>
            <button class="login-btn" onclick="closeAdmin()" style="background:#ccc; margin-top:10px; color:#555;">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="admin-panel">
        <div class="admin-header">
            <h1>ç®¡ç†å¾Œå°</h1>
            <div><button onclick="logoutAdmin()" class="control-btn">é›¢é–‹å¾Œå°</button></div>
        </div>
        <div class="admin-container">
            <div class="dashboard-grid">
                <div class="dash-card"><div class="dash-num" id="today-count">0</div><div class="dash-label">ä»Šæ—¥é ç´„</div></div>
                <div class="dash-card"><div class="dash-num" id="month-revenue" style="color:#e67e22;">$0</div><div class="dash-label">æœ¬æœˆé ä¼°ç‡Ÿæ”¶</div></div>
            </div>
            <div class="admin-card">
                <div class="admin-month-header">
                    <button class="month-btn" onclick="prevMonth()">â®</button>
                    <div class="month-title-group">
                        <div class="admin-month-title" id="adminMonthYear"></div>
                        <button class="today-btn" onclick="resetToToday()">å›åˆ°ä»Šå¤©</button>
                    </div>
                    <button class="month-btn" onclick="nextMonth()">â¯</button>
                </div>
                <div class="admin-toolbar"><button class="admin-tool-btn" onclick="toggleViewMode()" id="viewToggleBtn">ğŸ‘ï¸ åˆ‡æ›è©³ç´°æ¨¡å¼</button></div>
                <div class="admin-cal-grid" id="admin-cal-grid"></div>
            </div>
            <div id="day-detail">
                <div class="detail-header"><div class="date-title" id="admin-date-title"></div></div>
                <div id="order-list-container">è¼‰å…¥ä¸­...</div>
                <div class="admin-big-btn-group">
                    <button id="btn-set-holiday" class="admin-big-btn btn-holiday-big" onclick="toggleHoliday()">âŒ è¨­ç‚ºå…¨æ—¥åº—ä¼‘</button>
                    <button id="btn-open-holiday" class="admin-big-btn btn-open-big" onclick="toggleHoliday()">âœ… æ¢å¾©å…¨æ—¥é–‹æ”¾</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast-msg">âœ… è¨­å®šå·²æ›´æ–°</div>

    <script>
        // ğŸ”¥ V44.0 æ–°ç‰ˆ GAS ç¶²å€ (è«‹ç¢ºèªæ˜¯å¦æ­£ç¢ºæ›´æ–°)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwnQHXbyaGgTVdnjIfxf88QnL6HA2k70_PDQxNDDeYPXqLl056MAxMsBZ2NQQS5TkySKQ/exec"; 

        let currentDate = new Date();
        let selectedDate = null;
        let selectedTime = null;
        let allOrders = []; 
        let holidays = []; // ğŸ”¥ å‹•æ…‹æŠ“å–çš„åº—ä¼‘åå–®

        window.onload = function() {
            const frontGrid = document.querySelector('.calendar-grid');
            if(frontGrid) frontGrid.id = 'calendar-grid-front';
            updateCalendars(); 
            fetchOrders();
        };

        function fetchOrders() {
            fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                // å°‡è³‡æ–™æ‹†åˆ†ç‚ºä¸€èˆ¬è¨‚å–®å’Œåº—ä¼‘
                allOrders = data.filter(o => o.status !== 'holiday');
                // æŠ“å‡ºæ‰€æœ‰ status ç‚º holiday çš„æ—¥æœŸ
                holidays = data.filter(o => o.status === 'holiday').map(o => o.date);
                
                updateDashboard(); 
                updateCalendars(); 
            })
            .catch(err => console.error("è³‡æ–™è®€å–å¤±æ•—", err));
        }

        // --- æ ¸å¿ƒï¼šåº—ä¼‘è¨­å®šé‚è¼¯ ---
        function toggleHoliday() {
            if(!selectedDate) return;
            const dateStr = selectedDate; // æ ¼å¼ "12/18"
            
            // åˆ¤æ–·ç›®å‰æ˜¯å¦å·²ä¼‘
            const isCurrentlyHoliday = holidays.includes(dateStr);
            const actionText = isCurrentlyHoliday ? "æ¢å¾©é–‹æ”¾" : "è¨­ç‚ºåº—ä¼‘";
            
            if(!confirm(`ç¢ºå®šè¦å°‡ ${dateStr} ${actionText} å—ï¼Ÿ`)) return;

            showToast("â³ è™•ç†ä¸­...");
            
            const data = {
                action: "toggle_holiday",
                date: dateStr
            };

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(data),
                mode: "no-cors",
                headers: { "Content-Type": "text/plain" }
            }).then(() => {
                showToast(`âœ… ${dateStr} å·²${actionText}ï¼`);
                // ç‚ºäº†å³æ™‚æ›´æ–°ï¼Œæ‰‹å‹•æ›´æ–°æœ¬åœ°æ•¸æ“šï¼Œä¸ç”¨ç­‰é‡æ•´
                if(isCurrentlyHoliday) {
                    holidays = holidays.filter(d => d !== dateStr); // ç§»é™¤
                } else {
                    holidays.push(dateStr); // åŠ å…¥
                }
                updateCalendars(); // é‡ç•«æ—¥æ›†
                
                // é‡æ–°è§¸ç™¼ä¸€æ¬¡å¾Œå°è©³æƒ…æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                const day = parseInt(dateStr.split('/')[1]);
                // é€™è£¡ç°¡å–®è™•ç†ï¼šç›´æ¥éš±è—æŒ‰éˆ•å€åŸŸç­‰å¾…ä¸‹æ¬¡é»æ“Šï¼Œæˆ–è€…é‡æ–°å‘¼å« showAdminDetail
                // æœ€ç°¡å–®æ˜¯é‡æ•´ä»‹é¢ï¼š
                // ç¨å¾®å»¶é²å¾Œå†æŠ“ä¸€æ¬¡ç¢ºä¿åŒæ­¥
                setTimeout(fetchOrders, 1000);
                
            }).catch(e => alert("éŒ¯èª¤ï¼š" + e));
        }

        // --- æœˆæ›†é‚è¼¯ (åŒæ­¥æ›´æ–°) ---
        function updateCalendars() {
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth();
            const titleText = `${m + 1}æœˆ (${y})`;
            
            const frontTitle = document.getElementById('currentMonthYear');
            if(frontTitle) frontTitle.firstChild.nodeValue = titleText + " ";
            const adminTitle = document.getElementById('adminMonthYear');
            if(adminTitle) adminTitle.innerText = titleText;
            
            renderCalendar(y, m, 'calendar-grid-front', false);
            renderCalendar(y, m, 'admin-cal-grid', true);
        }

        function renderCalendar(year, month, elementId, isAdmin) {
            const container = document.getElementById(elementId);
            if(!container) return;
            container.innerHTML = "";
            
            const headers = ['MON','TUE','WED','THU','FRI','SAT','SUN'];
            headers.forEach(day => {
                const div = document.createElement('div');
                div.className = isAdmin ? 'admin-cal-head' : 'cal-header';
                if(day === 'SAT' || day === 'SUN') div.style.color = '#ff4757';
                div.innerText = day;
                container.appendChild(div);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let startSlot = (firstDay === 0) ? 6 : firstDay - 1;

            for(let i=0; i<startSlot; i++) {
                const empty = document.createElement('div');
                container.appendChild(empty);
            }

            const today = new Date();
            for(let i=1; i<=daysInMonth; i++) {
                const cell = document.createElement('div');
                cell.className = isAdmin ? 'admin-cal-cell' : 'calendar-day';
                
                const dateStr = `${month+1}/${i}`;
                const hasOrder = allOrders.some(o => o.date === dateStr);
                const isHoliday = holidays.includes(dateStr); 

                if(year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) {
                    cell.classList.add('today');
                    cell.innerHTML = `${i}<br><span style="font-size:0.6rem">ä»Šå¤©</span>`;
                } else if(isHoliday) {
                    // åº—ä¼‘é‚è¼¯ï¼šå‰å°è®Šç°ï¼Œå¾Œå°è®Šç´…
                    cell.classList.add('holiday');
                    if(isAdmin) {
                        cell.innerHTML = `${i}<br><span style="font-size:0.6rem;">åº—ä¼‘</span>`;
                    } else {
                        cell.classList.add('disabled'); // å‰å°ä¸å¯é»
                        cell.innerHTML = `${i}<br><span>åº—ä¼‘</span>`;
                    }
                } else {
                    cell.innerHTML = `${i}`;
                    if(!isAdmin) cell.innerHTML += `<br><span>å¯ç´„</span>`;
                }

                if(isAdmin && hasOrder) {
                    cell.innerHTML += `<div class="dot active"></div>`;
                    // è©³ç´°æ¨¡å¼æ–‡å­—
                    const dailyOrders = allOrders.filter(o => o.date === dateStr);
                    dailyOrders.forEach(o => {
                         cell.innerHTML += `<div class="event-text">${o.time} ${o.name}</div>`;
                    });
                }

                if(isAdmin) {
                    cell.onclick = function() { showAdminDetail(i, this); };
                } else {
                    if(!isHoliday) cell.onclick = function() { selectDate(i, this); };
                }
                container.appendChild(cell);
            }
        }

        function prevMonth() { currentDate.setMonth(currentDate.getMonth() - 1); updateCalendars(); }
        function nextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); updateCalendars(); }
        function resetToToday() { currentDate = new Date(); updateCalendars(); }

        // --- å‰å°é ç´„ ---
        function selectDate(day, element) {
            selectedDate = `${currentDate.getMonth()+1}/${day}`;
            let days = document.querySelectorAll('.calendar-day');
            days.forEach(d => d.classList.remove('active'));
            element.classList.add('active');
        }

        function openBookingForm(time) {
            if(!selectedDate) { alert("è«‹å…ˆé¸æ“‡æ—¥æœŸå–”ï¼"); return; }
            selectedTime = time;
            document.getElementById('booking-modal-overlay').style.display = 'flex';
            document.getElementById('booking-info-text').innerText = `æ‚¨é¸æ“‡çš„æ™‚æ®µï¼š${selectedDate} ${time}`;
            let times = document.querySelectorAll('.time-btn');
            times.forEach(t => t.classList.remove('selected'));
        }

        function closeBookingForm() { document.getElementById('booking-modal-overlay').style.display = 'none'; }

        function confirmBooking() {
            const name = document.getElementById('booking-name').value;
            const phone = document.getElementById('booking-phone').value.trim();
            const lineId = document.getElementById('booking-line').value;
            const service = document.getElementById('booking-service').value;

            if(!name || !phone) { alert("è«‹å¡«å¯«å§“åå’Œé›»è©±ï¼"); return; }
            // é›»è©±é©—è­‰
            const cleanPhone = phone.replace(/-/g, "");
            if (!/^09\d{8}$/.test(cleanPhone)) {
                alert("âŒ æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼éŒ¯èª¤ï¼\nè«‹è¼¸å…¥ 09 é–‹é ­çš„ 10 ç¢¼æ•¸å­—");
                return;
            }

            const btn = document.getElementById('confirm-btn');
            btn.innerText = "è™•ç†ä¸­...";
            btn.disabled = true;

            let amount = "0";
            const match = service.match(/\$(\d+,?\d*)/);
            if(match) amount = match[1].replace(',', '');
            if(service.includes("åŒ…å ‚")) amount = "åŒ…å ‚æ‰£1";

            const data = { 
                action: "order", // æ¨™è¨˜ç‚ºä¸€èˆ¬è¨‚å–®
                date: selectedDate, time: selectedTime, name, phone, lineId, service, amount 
            };

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(data),
                mode: "no-cors",
                headers: { "Content-Type": "text/plain" }
            }).then(() => {
                alert("âœ… é ç´„æˆåŠŸï¼\næˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„é ç´„ï¼Œè«‹æº–æ™‚å‰å¾€å·¥ä½œå®¤å³å¯ï¼");
                closeBookingForm();
                btn.innerText = "ç¢ºèªé€å‡º";
                btn.disabled = false;
                document.getElementById('booking-name').value = "";
                document.getElementById('booking-phone').value = "";
                document.getElementById('booking-line').value = "";
                setTimeout(fetchOrders, 2000); 
            }).catch(e => {
                alert("éŒ¯èª¤ï¼š" + e);
                btn.disabled = false;
            });
        }

        // --- å¾Œå°é‚è¼¯ ---
        function openAdmin() { document.getElementById('admin-login-overlay').style.display = 'flex'; }
        function closeAdmin() { document.getElementById('admin-login-overlay').style.display = 'none'; }
        function checkAdminLogin() {
            const pwd = document.getElementById('admin-password').value;
            if(pwd === '8888') { 
                document.getElementById('admin-login-overlay').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                document.body.style.overflow = 'hidden'; 
                fetchOrders(); 
            } else { alert('å¯†ç¢¼éŒ¯èª¤ï¼'); }
        }
        function logoutAdmin() {
            document.getElementById('admin-panel').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('admin-password').value = '';
        }

        function updateDashboard() {
            const todayStr = `${new Date().getMonth()+1}/${new Date().getDate()}`;
            const todayCount = allOrders.filter(o => o.date === todayStr).length;
            document.getElementById('today-count').innerText = todayCount;

            let total = 0;
            allOrders.forEach(o => {
                const price = parseInt(o.amount);
                if(!isNaN(price)) total += price;
            });
            document.getElementById('month-revenue').innerText = `$${total.toLocaleString()}`;
        }

        function showAdminDetail(day, element) {
            document.querySelectorAll('.admin-cal-cell').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
            
            // è¨˜å¾—ï¼šcurrentDate æ˜¯ç•¶ä¸‹æœˆæ›†é¡¯ç¤ºçš„æœˆä»½
            // æ‰€ä»¥è¦ç”¨ currentDate.getMonth() è€Œä¸æ˜¯ new Date().getMonth()
            selectedDate = `${currentDate.getMonth()+1}/${day}`; // æ›´æ–°å…¨åŸŸé¸å–æ—¥æœŸ
            
            document.getElementById('admin-date-title').innerText = selectedDate;
            document.getElementById('day-detail').style.display = 'block';

            // åˆ¤æ–·è©²æ—¥æ˜¯å¦åº—ä¼‘ï¼Œåˆ‡æ›æŒ‰éˆ•é¡¯ç¤º
            const isHoliday = holidays.includes(selectedDate);
            const btnHoliday = document.getElementById('btn-set-holiday');
            const btnOpen = document.getElementById('btn-open-holiday');
            
            if(isHoliday) {
                btnHoliday.style.display = 'none';
                btnOpen.style.display = 'flex'; // é¡¯ç¤ºæ¢å¾©é–‹æ”¾
            } else {
                btnHoliday.style.display = 'flex'; // é¡¯ç¤ºè¨­ç‚ºåº—ä¼‘
                btnOpen.style.display = 'none';
            }

            // é¡¯ç¤ºè¨‚å–®
            const dailyOrders = allOrders.filter(o => o.date === selectedDate);
            const listContainer = document.getElementById('order-list-container');
            
            if(dailyOrders.length === 0) {
                listContainer.innerHTML = `<p style="text-align:center; color:#999; padding:20px;">ä»Šæ—¥ç„¡é ç´„</p>`;
            } else {
                let html = "";
                dailyOrders.forEach(o => {
                    const lineInfo = o.lineId ? `<br>LINE: ${o.lineId}` : "";
                    html += `
                    <div class="order-item">
                        <div class="order-time">${o.time}</div>
                        <div class="order-info">
                            ${o.name} (${o.phone})${lineInfo}<br>
                            ${o.service}<br>
                            <span class="order-price">ğŸ’° ${o.amount} (æœªä»˜æ¬¾)</span>
                        </div>
                    </div>`;
                });
                listContainer.innerHTML = html;
            }
            // æ²å‹•
            document.getElementById('day-detail').scrollIntoView({behavior: "smooth"});
        }
        
        function toggleViewMode() {
            const grid = document.getElementById('admin-cal-grid');
            const btn = document.getElementById('viewToggleBtn');
            grid.classList.toggle('detail-mode');
            if (grid.classList.contains('detail-mode')) {
                btn.innerText = "ğŸ‘ï¸ åˆ‡æ›ç°¡æ˜“æ¨¡å¼";
            } else {
                btn.innerText = "ğŸ‘ï¸ åˆ‡æ›è©³ç´°æ¨¡å¼";
            }
        }
        
        function showToast(msg) {
            const toast = document.getElementById('toast-msg');
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 2000);
        }
        
        // Swiper è¨­å®š... (ä¿ç•™)
        var swiper = new Swiper(".mySwiper", { slidesPerView: 1, slidesPerGroup: 1, spaceBetween: 20, loop: true, breakpoints: { 768: { slidesPerView: 3, slidesPerGroup: 3, spaceBetween: 30 } }, pagination: { el: ".swiper-pagination", clickable: true }, navigation: { nextEl: ".my-next-btn", prevEl: ".my-prev-btn" }, autoplay: { delay: 4000, disableOnInteraction: false } });
        var offerSwiper = new Swiper(".offerSwiper", { slidesPerView: 1, spaceBetween: 30, loop: true, autoplay: { delay: 5000, disableOnInteraction: false }, pagination: { el: ".offerSwiper .swiper-pagination", clickable: true }, navigation: { nextEl: ".offerSwiper .swiper-button-next", prevEl: ".offerSwiper .swiper-button-prev" } });
        
        let isScrolling;
        const floatBtns = document.querySelector('.floating-btn-container');
        window.addEventListener('scroll', function() {
            floatBtns.style.opacity = '1'; floatBtns.style.pointerEvents = 'auto'; 
            window.clearTimeout(isScrolling);
            isScrolling = setTimeout(function() { floatBtns.style.opacity = '0.3'; }, 2000); 
        }, false);
        
        let lastScrollTop = 0;
        const header = document.querySelector('header');
        window.addEventListener('scroll', function() {
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            if (scrollTop > lastScrollTop && scrollTop > 50) { header.classList.add('nav-hidden'); } else { header.classList.remove('nav-hidden'); }
            lastScrollTop = scrollTop;
        });
    </script>
</body>
</html>
